<!doctype html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IFS Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="topbar">
        <div class="brand">
            <div class="title">MEKA: KÄ±rma Eleme ve Beton Santrali Teknolojileri</div>
            <div class="sub">PDKS + Ä°ÅŸÃ§ilik | CanlÄ± veri (IFS Oracle)</div>
        </div>

        <div class="filters">
            <label>
                BaÅŸlangÄ±Ã§
                <input id="baslangic" type="date" />
            </label>
            <label>
                BitiÅŸ
                <input id="bitis" type="date" />
            </label>
            <button id="btnYenile">Yenile</button>
            <span id="durum" class="status"></span>
        </div>
    </div>
    <div class="nav">
        <a href="anadashboard.html" class="active">PDKS-Ä°ÅŸÃ§ilik</a>
        <a href="uretim.html">Ãœretim</a>
    </div>

    <div class="container">
        <!-- KPIs -->
        <div class="kpi-row">
            <div class="kpi">
                <div class="label">Toplam PDKS Saat</div>
                <div id="kpiPdksToplam" class="value">-</div>
                <div class="hint">SeÃ§ili tarih aralÄ±ÄŸÄ±</div>
            </div>
            <div class="kpi">
                <div class="label">PDKS KayÄ±t SayÄ±sÄ±</div>
                <div id="kpiPdksKayit" class="value">-</div>
                <div class="hint">SatÄ±r adedi</div>
            </div>
            <div class="kpi">
                <div class="label">Toplam Ä°ÅŸÃ§ilik SÃ¼resi</div>
                <div id="kpiIscilikToplam" class="value">-</div>
                <div class="hint">Endpoint eklenince dolacak</div>
            </div>
            <div class="kpi">
                <div class="label">Ä°ÅŸ Emri SayÄ±sÄ±</div>
                <div id="kpiOrder" class="value">-</div>
                <div class="hint">Endpoint eklenince dolacak</div>
            </div>
        </div>

        <div class="grid">
            <!-- Left big charts -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">GÃ¼nlÃ¼k PDKS Toplam Ã‡alÄ±ÅŸma (Saat)</div>
                        <div class="card-sub">GÃ¼n bazÄ±nda toplam saat (tÃ¼m Ã§alÄ±ÅŸanlar)</div>
                    </div>
                    <span class="pill">PDKS</span>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartGunlukPdks"></canvas>
                </div>
            </div>

            <!-- Right -->
            <div class="split">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Ä°ÅŸyeri BazlÄ± PDKS PayÄ±</div>
                            <div class="card-sub">Ä°ÅŸyeri koduna gÃ¶re toplam saat daÄŸÄ±lÄ±mÄ±</div>
                        </div>
                        <span class="pill">DaÄŸÄ±lÄ±m</span>
                    </div>
                    <div class="chart-wrap">
                        <canvas id="chartIsyeriPdks"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">En YÃ¼ksek 10 Ã‡alÄ±ÅŸan (PDKS Saat)</div>
                            <div class="card-sub">Toplam Ã§alÄ±ÅŸma sÃ¼resine gÃ¶re</div>
                        </div>
                        <span class="pill">Top 10</span>
                    </div>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>EmpNo</th>
                                <th>Ad Soyad</th>
                                <th>Ä°ÅŸyeri</th>
                                <th style="text-align:right">Saat</th>
                            </tr>
                        </thead>
                        <tbody id="tblTop10">
                            <!-- JS dolduracak -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Second row for Ä°ÅŸÃ§ilik -->
        <div class="charts">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Ä°ÅŸÃ§ilik SÃ¼releri (Ä°ÅŸyeri / Work Center)</div>
                        <div class="card-sub">Endpoint eklenince otomatik dolacak</div>
                    </div>
                    <span class="pill">Ä°ÅŸÃ§ilik</span>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartIscilik"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Notlar / Filtreler</div>
                        <div class="card-sub">Dashboard geniÅŸletme alanÄ±</div>
                    </div>
                    <span class="pill">Opsiyonel</span>
                </div>
                <div class="status">
                    âœ… Åu an PDKS verisi APIâ€™den geliyor.<br />
                    â­ï¸ SÄ±radaki adÄ±m: Ä°ÅŸÃ§ilik endpointâ€™i eklemek ve bu grafiÄŸe baÄŸlamak.<br />
                    ğŸ”§ Ä°stersen buraya â€œMY01 / fabrika / departmanâ€ filtreleri ekleriz.
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:5151";

        let chartGunlukPdks = null;
        let chartIsyeriPdks = null;
        let chartIscilik = null;

        function setDurum(msg) { document.getElementById("durum").textContent = msg; }

        function toISODate(d) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function formatSaat(x) {
            const n = Number(x ?? 0);
            return n.toLocaleString("tr-TR", { maximumFractionDigits: 2 });
        }

        async function getJson(url) {
            const res = await fetch(url);
            if (!res.ok) {
                const t = await res.text();
                throw new Error(`HTTP ${res.status} - ${t}`);
            }
            return res.json();
        }

        function destroyIfExists(chart) {
            if (chart) { chart.destroy(); }
            return null;
        }

        function fillTop10(rows) {
            const tbody = document.getElementById("tblTop10");
            tbody.innerHTML = "";

            for (const r of rows) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
          <td>${r.empNo ?? ""}</td>
          <td>${r.employeeName ?? ""}</td>
          <td>${r.isyeriKodu ?? ""}</td>
          <td style="text-align:right">${formatSaat(r.toplamCalismaSaat)}</td>
        `;
                tbody.appendChild(tr);
            }
        }

        async function yenile() {
            try {
                setDurum("Veriler Ã§ekiliyorâ€¦");

                const baslangic = document.getElementById("baslangic").value;
                const bitis = document.getElementById("bitis").value;

                const pdksUrl = `${API_BASE}/api/Dashboard/pdks?baslangic=${baslangic}&bitis=${bitis}`;
                const pdks = await getJson(pdksUrl);

                // KPI
                const pdksToplam = pdks.reduce((acc, x) => acc + Number(x.toplamCalismaSaat ?? 0), 0);
                document.getElementById("kpiPdksToplam").textContent = formatSaat(pdksToplam);
                document.getElementById("kpiPdksKayit").textContent = pdks.length.toLocaleString("tr-TR");

                // 1) GÃ¼nlÃ¼k toplam (gun -> toplam)
                const gunMap = {};
                for (const x of pdks) {
                    const g = x.gun;
                    gunMap[g] = (gunMap[g] ?? 0) + Number(x.toplamCalismaSaat ?? 0);
                }
                const gunLabels = Object.keys(gunMap);
                const gunValues = Object.values(gunMap);

                chartGunlukPdks = destroyIfExists(chartGunlukPdks);
                chartGunlukPdks = new Chart(document.getElementById("chartGunlukPdks"), {
                    type: "bar",
                    data: {
                        labels: gunLabels,
                        datasets: [{ label: "Toplam Saat", data: gunValues }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: "rgba(232,240,255,.7)" }, grid: { color: "rgba(255,255,255,.06)" } },
                            y: { ticks: { color: "rgba(232,240,255,.7)" }, grid: { color: "rgba(255,255,255,.06)" } }
                        }
                    }
                });

                // 2) Ä°ÅŸyeri daÄŸÄ±lÄ±mÄ±
                const isyeriMap = {};
                for (const x of pdks) {
                    const k = x.isyeriKodu ?? "Bilinmiyor";
                    isyeriMap[k] = (isyeriMap[k] ?? 0) + Number(x.toplamCalismaSaat ?? 0);
                }
                const isyeriLabels = Object.keys(isyeriMap);
                const isyeriValues = Object.values(isyeriMap);

                chartIsyeriPdks = destroyIfExists(chartIsyeriPdks);
                chartIsyeriPdks = new Chart(document.getElementById("chartIsyeriPdks"), {
                    type: "doughnut",
                    data: {
                        labels: isyeriLabels,
                        datasets: [{ data: isyeriValues }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "right",
                                labels: { color: "rgba(232,240,255,.75)" }
                            }
                        }
                    }
                });

                // 3) Top 10 Ã§alÄ±ÅŸan
                const empMap = {};
                for (const x of pdks) {
                    const key = (x.empNo ?? "") + "|" + (x.employeeName ?? "") + "|" + (x.isyeriKodu ?? "");
                    if (!empMap[key]) {
                        empMap[key] = { empNo: x.empNo, employeeName: x.employeeName, isyeriKodu: x.isyeriKodu, toplamCalismaSaat: 0 };
                    }
                    empMap[key].toplamCalismaSaat += Number(x.toplamCalismaSaat ?? 0);
                }
                const top10 = Object.values(empMap)
                    .sort((a, b) => b.toplamCalismaSaat - a.toplamCalismaSaat)
                    .slice(0, 10);

                fillTop10(top10);

                try {
                    const iscilikUrl = `${API_BASE}/api/Dashboard/iscilik?baslangic=${baslangic}&bitis=${bitis}`;
                    const iscilik = await getJson(iscilikUrl);
                    const isLabels = iscilik.map(x => x.workCenterAdi ?? x.work_center_adi ?? "Bilinmiyor");
                    const isValues = iscilik.map(x => Number(x.toplamEmekSuresi ?? x.toplam_emek_suresi ?? 0));

                    const isToplam = isValues.reduce((a, b) => a + b, 0);
                    document.getElementById("kpiIscilikToplam").textContent = formatSaat(isToplam);

                    // order sayÄ±sÄ± varsa:
                    const orderSet = new Set(iscilik.map(x => x.orderNo ?? x.order_no).filter(Boolean));
                    document.getElementById("kpiOrder").textContent = orderSet.size.toLocaleString("tr-TR");

                    chartIscilik = destroyIfExists(chartIscilik);
                    chartIscilik = new Chart(document.getElementById("chartIscilik"), {
                        type: "bar",
                        data: { labels: isLabels, datasets: [{ label: "Toplam Ä°ÅŸÃ§ilik", data: isValues }] },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { ticks: { color: "rgba(232,240,255,.7)" }, grid: { color: "rgba(255,255,255,.06)" } },
                                y: { ticks: { color: "rgba(232,240,255,.7)" }, grid: { color: "rgba(255,255,255,.06)" } }
                            }
                        }
                    });
                } catch (e) {
                    document.getElementById("kpiIscilikToplam").textContent = "-";
                    document.getElementById("kpiOrder").textContent = "-";
                }

                setDurum("GÃ¼ncel âœ…");
            } catch (err) {
                console.error(err);
                setDurum("Hata: " + err.message);
            }
        }

        const today = new Date();
        document.getElementById("bitis").value = toISODate(today);
        document.getElementById("baslangic").value = toISODate(new Date(today.getTime() - 29 * 24 * 60 * 60 * 1000));

        document.getElementById("btnYenile").addEventListener("click", yenile);

        yenile();
    </script>
</body>

</html>