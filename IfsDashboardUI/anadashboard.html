<!doctype html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IFS Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="topbar">
        <div class="brand">
            <div class="title">MEKA: KÄ±rma Eleme ve Beton Santrali Teknolojileri</div>
            <div class="sub">PDKS + Ä°ÅŸÃ§ilik | CanlÄ± veri (IFS Oracle)</div>
        </div>

        <div class="filters">
            <label>
                BaÅŸlangÄ±Ã§ Tarihi :
                <input id="baslangic" type="date" />
            </label>
            <label>
                BitiÅŸ Tarihi :
                <input id="bitis" type="date" />
            </label>
            <button id="btnYenile">Yenile</button>
            <span id="durum" class="status"></span>
        </div>
    </div>
    <div class="nav-wrap">
        <div class="nav">
            <a href="anadashboard.html" class="active">PDKS-Ä°ÅŸÃ§ilik</a>
            <a href="uretim.html">Ãœretim</a>
            <a href="ik.html">Ä°nsan KaynaklarÄ±</a>
        </div>
    </div>
    <div class="container">
        <div class="kpi-row">
            <div class="kpi">
                <div class="label">Toplam PDKS Saat</div>
                <div id="kpiPdksToplam" class="value">-</div>
                <div class="hint">SeÃ§ili tarih aralÄ±ÄŸÄ±</div>
            </div>
            <div class="kpi">
                <div class="label">PDKS KayÄ±t SayÄ±sÄ±</div>
                <div id="kpiPdksKayit" class="value">-</div>
                <div class="hint">SatÄ±r adedi</div>
            </div>
            <div class="kpi">
                <div class="label">Toplam Ä°ÅŸÃ§ilik SÃ¼resi</div>
                <div id="kpiIscilikToplam" class="value">-</div>
                <div class="hint">SeÃ§ili tarih aralÄ±ÄŸÄ±</div>
            </div>
            <div class="kpi">
                <div class="label">Ä°ÅŸ Merkezi SayÄ±sÄ±</div>
                <div id="kpiWorkCenter" class="value">-</div>
                <div class="hint">Ä°ÅŸÃ§ilik sÃ¼relerinden</div>
            </div>
        </div>

        <div class="grid">

            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">GÃ¼nlÃ¼k PDKS Toplam Ã‡alÄ±ÅŸma (Saat)</div>
                        <div class="card-sub">GÃ¼n bazÄ±nda toplam saat (tÃ¼m Ã§alÄ±ÅŸanlar)</div>
                    </div>
                    <span class="pill">PDKS</span>
                </div>
                <div class="chart-wrap">
                    <canvas id="chartGunlukPdks"></canvas>
                </div>
            </div>
            <div class="split">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Ä°ÅŸyeri BazlÄ± PDKS PayÄ±</div>
                            <div class="card-sub">Ä°ÅŸyeri koduna gÃ¶re toplam saat daÄŸÄ±lÄ±mÄ±</div>
                        </div>
                        <span class="pill">DaÄŸÄ±lÄ±m</span>
                    </div>
                    <div class="chart-wrap">
                        <canvas id="chartIsyeriPdks"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="charts charts-big">
            <div class="card card-big">
                <div class="card-header">
                    <div>
                        <div class="card-title">Ä°ÅŸyeri BazlÄ± PDKS ve Ä°ÅŸÃ§ilik (Tarih Serisi)</div>
                        <div class="card-sub">PDKS (dÃ¼z) + Ä°ÅŸÃ§ilik (kesikli) aynÄ± tarihte gÃ¶sterilir</div>
                    </div>
                    <span class="pill">PDKS + Ä°ÅŸÃ§ilik</span>
                </div>
                <div class="chart-wrap chart-wrap-big">
                    <canvas id="chartIscilik"></canvas>
                </div>
            </div>

            <div class="card card-notes">
                <div class="card-header">
                    <div>
                        <div class="card-title">Notlar</div>
                        <div class="card-sub">Ã–zet / Hatalar</div>
                    </div>
                </div>

                <div id="notlar" class="status status-compact">
                    âœ… PDKS + Ä°ÅŸÃ§ilik ayrÄ± sorgulardan geliyor<br />
                    ğŸ” Ä°ÅŸÃ§ilik tarih bazlÄ±<br />
                    âš ï¸ Sadece MEKA 1/2/3/4/ESK<br />
                    ğŸ“Š PDKS dÃ¼z Ã§izgi / Ä°ÅŸÃ§ilik kesikli Ã§izgi
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:5151";

        let chartGunlukPdks = null;
        let chartIsyeriPdks = null;
        let chartIscilik = null;

        function setDurum(msg) { document.getElementById("durum").textContent = msg; }

        function setNot(msg) {
            const el = document.getElementById("notlar");
            el.innerHTML = `âš ï¸ ${msg}<br/>` + el.innerHTML;
        }

        function toISODate(d) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // "01.01.2025" -> Date
        function parseTrDate(s) {
            if (!s) return null;
            const parts = String(s).split(".");
            if (parts.length !== 3) return null;
            const [dd, mm, yyyy] = parts.map(x => parseInt(x, 10));
            return new Date(yyyy, mm - 1, dd);
        }

        function formatSaat(x) {
            const n = Number(x ?? 0);
            return n.toLocaleString("tr-TR", { maximumFractionDigits: 2 });
        }

        async function getJson(url) {
            const res = await fetch(url);
            if (!res.ok) {
                const t = await res.text();
                throw new Error(`HTTP ${res.status} - ${t}`);
            }
            return res.json();
        }

        function destroyIfExists(chart) {
            if (chart) chart.destroy();
            return null;
        }

        function isyeriFromWorkCenterAdi(workCenterAdi) {
            const wc = (workCenterAdi ?? "").toUpperCase();
            if (wc.includes("MEKA 1")) return "MEKA 1";
            if (wc.includes("MEKA 2")) return "MEKA 2";
            if (wc.includes("MEKA 3")) return "MEKA 3";
            if (wc.includes("MEKA 4")) return "MEKA 4";
            if (wc.includes("MEKA ESK")) return "MEKA ESK";
            return "Bilinmiyor";
        }

        function getColorForIsyeri(isyeri, tip, alpha = 1) {
            const renkler = {
                "MEKA 1": [31, 182, 255],
                "MEKA 2": [34, 197, 94],
                "MEKA 3": [168, 85, 247],
                "MEKA 4": [245, 158, 11],
                "MEKA ESK": [239, 68, 68],
                "Bilinmiyor": [148, 163, 184],
            };
            const rgb = renkler[isyeri] ?? renkler["Bilinmiyor"];
            return `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${alpha})`;
        }

        async function yenile() {
            try {
                setDurum("Veriler Ã§ekiliyorâ€¦");
                let baslangic = document.getElementById("baslangic").value;
                let bitis = document.getElementById("bitis").value;

                if (!bitis) bitis = toISODate(new Date());
                if (!baslangic) baslangic = toISODate(new Date(new Date().setDate(new Date().getDate() - 7)));

                const pdksUrl = `${API_BASE}/api/Dashboard/pdks?baslangic=${encodeURIComponent(baslangic)}&bitis=${encodeURIComponent(bitis)}`;
                const iscilikUrl = `${API_BASE}/api/Dashboard/iscilik?baslangic=${encodeURIComponent(baslangic)}&bitis=${encodeURIComponent(bitis)}`;

                const [pdks, iscilik] = await Promise.all([getJson(pdksUrl), getJson(iscilikUrl)]);

                // KPI - PDKS
                const pdksToplam = pdks.reduce((acc, x) => acc + Number(x.toplamCalismaSaat ?? 0), 0);
                document.getElementById("kpiPdksToplam").textContent = formatSaat(pdksToplam);
                document.getElementById("kpiPdksKayit").textContent = (pdks?.length ?? 0).toLocaleString("tr-TR");

                // KPI - Ä°ÅŸÃ§ilik
                const isToplam = iscilik.reduce((a, b) => a + Number(b.toplamEmekSuresi ?? 0), 0);
                document.getElementById("kpiIscilikToplam").textContent = formatSaat(isToplam);

                const wcSet = new Set(iscilik.map(x => x.workCenterAdi).filter(Boolean));
                document.getElementById("kpiWorkCenter").textContent = wcSet.size.toLocaleString("tr-TR");

                // 1) GÃ¼nlÃ¼k toplam PDKS
                const gunMap = {};
                for (const x of pdks) {
                    const g = x.gun;
                    gunMap[g] = (gunMap[g] ?? 0) + Number(x.toplamCalismaSaat ?? 0);
                }

                const gunLabels = Object.keys(gunMap).sort((a, b) => (parseTrDate(a) - parseTrDate(b)));
                const gunValues = gunLabels.map(g => gunMap[g]);

                chartGunlukPdks = destroyIfExists(chartGunlukPdks);
                chartGunlukPdks = new Chart(document.getElementById("chartGunlukPdks"), {
                    type: "bar",
                    data: { labels: gunLabels, datasets: [{ label: "Toplam Saat", data: gunValues }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: "rgba(232,240,255,.7)" }, grid: { color: "rgba(255,255,255,.06)" } },
                            y: { ticks: { color: "rgba(232,240,255,.7)" }, grid: { color: "rgba(255,255,255,.06)" } }
                        }
                    }
                });

                // 2) Ä°ÅŸyeri daÄŸÄ±lÄ±mÄ± (PDKS)
                const isyeriMap = {};
                for (const x of pdks) {
                    const k = x.isyeriKodu ?? "Bilinmiyor";
                    isyeriMap[k] = (isyeriMap[k] ?? 0) + Number(x.toplamCalismaSaat ?? 0);
                }
                const isyeriLabels = Object.keys(isyeriMap);
                const isyeriValues = Object.values(isyeriMap);

                chartIsyeriPdks = destroyIfExists(chartIsyeriPdks);
                chartIsyeriPdks = new Chart(document.getElementById("chartIsyeriPdks"), {
                    type: "doughnut",
                    data: { labels: isyeriLabels, datasets: [{ data: isyeriValues }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: "right", labels: { color: "rgba(232,240,255,.75)" } } }
                    }
                });

                // 3) PDKS + Ä°ÅŸÃ§ilik tarih serisi (iÅŸyeri bazlÄ±)
                const tarihMap = new Map();

                // PDKS ekle
                for (const x of pdks) {
                    const tarih = x.gun;
                    const isyeri = x.isyeriKodu ?? "Bilinmiyor";

                    if (!tarihMap.has(tarih)) tarihMap.set(tarih, {});
                    if (!tarihMap.get(tarih)[isyeri]) tarihMap.get(tarih)[isyeri] = { pdks: 0, iscilik: 0 };

                    tarihMap.get(tarih)[isyeri].pdks += Number(x.toplamCalismaSaat ?? 0);
                }

                // Ä°ÅŸÃ§ilik ekle
                for (const x of iscilik) {
                    const tarih = x.tarih;
                    const isyeri = isyeriFromWorkCenterAdi(x.workCenterAdi);

                    if (!tarihMap.has(tarih)) tarihMap.set(tarih, {});
                    if (!tarihMap.get(tarih)[isyeri]) tarihMap.get(tarih)[isyeri] = { pdks: 0, iscilik: 0 };

                    tarihMap.get(tarih)[isyeri].iscilik += Number(x.toplamEmekSuresi ?? 0);
                }

                const tumTarihler = Array.from(tarihMap.keys()).sort((a, b) => parseTrDate(a) - parseTrDate(b));

                const tumIsyerleri = new Set();
                for (const isyeriData of tarihMap.values()) {
                    Object.keys(isyeriData).forEach(isyeri => tumIsyerleri.add(isyeri));
                }

                const datasets = [];

                for (const isyeri of tumIsyerleri) {
                    const pdksValues = tumTarihler.map(t => (tarihMap.get(t)?.[isyeri]?.pdks) ?? 0);
                    const iscilikValues = tumTarihler.map(t => (tarihMap.get(t)?.[isyeri]?.iscilik) ?? 0);

                    datasets.push({
                        label: `${isyeri} - PDKS`,
                        data: pdksValues,
                        borderColor: getColorForIsyeri(isyeri, 'pdks', 1),
                        backgroundColor: getColorForIsyeri(isyeri, 'pdks', 0.10),
                        tension: 0.35,
                        fill: false,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    });

                    datasets.push({
                        label: `${isyeri} - Ä°ÅŸÃ§ilik`,
                        data: iscilikValues,
                        borderColor: getColorForIsyeri(isyeri, 'iscilik', 1),
                        backgroundColor: getColorForIsyeri(isyeri, 'iscilik', 0.10),
                        tension: 0.35,
                        fill: false,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        borderDash: [6, 6]
                    });
                }

                chartIscilik = destroyIfExists(chartIscilik);
                chartIscilik = new Chart(document.getElementById("chartIscilik"), {
                    type: "line",
                    data: { labels: tumTarihler, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { color: "rgba(232,240,255,.75)" } },
                            title: {
                                display: true,
                                text: 'Ä°ÅŸ Yeri BazlÄ± PDKS (DÃ¼z) + Ä°ÅŸÃ§ilik (Kesikli)',
                                color: "rgba(232,240,255,.9)",
                                font: { size: 14 }
                            }
                        },
                        scales: {
                            x: { ticks: { color: "rgba(232,240,255,.7)" }, grid: { color: "rgba(255,255,255,.06)" } },
                            y: { ticks: { color: "rgba(232,240,255,.7)" }, grid: { color: "rgba(255,255,255,.06)" } }
                        },
                        interaction: { intersect: false, mode: 'index' }
                    }
                });

                setDurum("GÃ¼ncel âœ…");
            } catch (err) {
                console.error(err);
                setDurum("Hata: " + err.message);
                setNot(err.message);
            }
        }

        /* default tarih: son 15 gÃ¼n  istege gÃ¶re sonra aÃ§abiliriz
        const today = new Date();
        document.getElementById("bitis").value = toISODate(today);
        document.getElementById("baslangic").value = toISODate(new Date(today.getFullYear(), today.getMonth(), today.getDate() - 14));*/

        document.getElementById("btnYenile").addEventListener("click", yenile);
        yenile();
    </script>
</body>

</html>